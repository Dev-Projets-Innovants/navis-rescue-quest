# Flux de jeu et r√®gles

## üéÆ Vue d'ensemble du jeu

Mission Navis est un jeu collaboratif o√π une √©quipe doit d√©verrouiller 4 bo√Ætes th√©matiques avant la fin du timer en r√©pondant correctement √† des quiz.

## üéØ Objectif

D√©verrouiller les 4 bo√Ætes (A, B, C, D) en :
1. R√©pondant correctement aux questions de chaque bo√Æte
2. Obtenant le code de d√©verrouillage
3. Validant le code avant la fin du temps

## ‚è±Ô∏è Contraintes

- **Timer global** : 60 minutes pour toute la mission
- **Un joueur par bo√Æte** : Une seule personne peut travailler sur une bo√Æte √† la fois
- **5 questions par bo√Æte** : Chaque bo√Æte contient un quiz de 5 questions
- **Code de d√©verrouillage** : Obtenu apr√®s avoir r√©ussi le quiz

## üìä Diagramme de flux complet

```mermaid
flowchart TD
    Start([D√©marrage]) --> Landing[Page d'accueil]
    Landing --> Connect[Connexion]
    
    Connect --> Choice{Action?}
    Choice -->|Cr√©er| Create[Cr√©er session]
    Choice -->|Rejoindre| Join[Rejoindre session]
    
    Create --> GenCode[G√©n√©rer code BOAT-XXXX]
    GenCode --> CreateDB[Cr√©er session en DB]
    CreateDB --> AddPlayer1[Ajouter joueur cr√©ateur]
    
    Join --> EnterCode[Entrer code session]
    EnterCode --> ValidateCode{Code valide?}
    ValidateCode -->|Non| ErrorCode[Erreur: Code invalide]
    ValidateCode -->|Oui| AddPlayer2[Ajouter joueur]
    
    ErrorCode --> Connect
    AddPlayer1 --> Dashboard
    AddPlayer2 --> Dashboard
    
    Dashboard[Dashboard principal] --> Timer{Timer actif?}
    Timer -->|Non| GameOver[Fin du jeu]
    Timer -->|Oui| CheckBoxes{Toutes d√©verrouill√©es?}
    
    CheckBoxes -->|Oui| Victory[√âcran de victoire]
    CheckBoxes -->|Non| SelectBox[S√©lectionner une bo√Æte]
    
    SelectBox --> CheckLocked{Bo√Æte d√©verrouill√©e?}
    CheckLocked -->|Oui| Dashboard
    CheckLocked -->|Non| CheckInProgress{Bo√Æte en cours?}
    
    CheckInProgress -->|Oui, autre joueur| BlockedBox[Bo√Æte occup√©e]
    CheckInProgress -->|Oui, m√™me joueur| ResumeQuiz[Reprendre quiz]
    CheckInProgress -->|Non| StartQuiz[Commencer quiz]
    
    BlockedBox --> Dashboard
    
    StartQuiz --> CreateAttempt[Cr√©er tentative en DB]
    CreateAttempt --> ShowQuestion
    
    ResumeQuiz --> LoadProgress[Charger progression]
    LoadProgress --> ShowQuestion
    
    ShowQuestion[Afficher question] --> Answer[R√©pondre]
    Answer --> SaveAnswer[Sauvegarder r√©ponse]
    SaveAnswer --> NextQ{Derni√®re question?}
    
    NextQ -->|Non| ShowQuestion
    NextQ -->|Oui| CalcScore[Calculer score]
    
    CalcScore --> ValidationPage[Page validation]
    ValidationPage --> ShowResults[Afficher r√©sultats]
    
    ShowResults --> CheckSuccess{3/5 ou plus?}
    CheckSuccess -->|Non| RetryOption{R√©essayer?}
    CheckSuccess -->|Oui| ShowCode[Afficher code]
    
    RetryOption -->|Oui| StartQuiz
    RetryOption -->|Non| Dashboard
    
    ShowCode --> UnlockPage[Page d√©verrouillage]
    UnlockPage --> EnterUnlockCode[Entrer code]
    EnterUnlockCode --> ValidateUnlockCode{Code correct?}
    
    ValidateUnlockCode -->|Non| ErrorUnlock[Erreur: Code incorrect]
    ValidateUnlockCode -->|Oui| UnlockBox[Marquer bo√Æte d√©verrouill√©e]
    
    ErrorUnlock --> UnlockPage
    UnlockBox --> Dashboard
    
    GameOver --> End([Fin])
    Victory --> End
```

## üó∫Ô∏è Navigation d√©taill√©e

### 1. Landing Page (`/`)
**Objectif** : Page d'accueil avec pr√©sentation

**Actions possibles** :
- Cliquer sur "Commencer" ‚Üí Redirige vers `/connect`

---

### 2. Connect Page (`/connect`)
**Objectif** : Cr√©er ou rejoindre une session

**Formulaire** :
- Entrer un pseudo
- Choisir "Cr√©er une session" ou "Rejoindre une session"
- Si rejoindre : entrer le code session

**Logique** :
```typescript
// Cr√©er une session
1. G√©n√©rer code unique (BOAT-XXXX)
2. Cr√©er session en DB (game_sessions)
3. Ajouter joueur cr√©ateur (session_players)
4. Charger questions depuis data/questions.ts
5. Sauvegarder en localStorage
6. Rediriger vers /dashboard

// Rejoindre une session
1. V√©rifier que la session existe et est active
2. Ajouter joueur √† la session (session_players)
3. R√©cup√©rer donn√©es session
4. Sauvegarder en localStorage
5. Rediriger vers /dashboard
```

**Validations** :
- ‚úÖ Pseudo non vide
- ‚úÖ Code session valide (si rejoindre)
- ‚úÖ Session active

---

### 3. Dashboard Page (`/dashboard`)
**Objectif** : Vue d'ensemble des 4 bo√Ætes et du timer

**Affichage** :
- Timer global (60 minutes)
- Code de la session
- Liste des joueurs
- 4 bo√Ætes avec leur statut :
  - üîí **Locked** (verrouill√©e) - Gris
  - ‚è≥ **In Progress** (en cours) - Orange, avec nom du joueur
  - ‚úÖ **Unlocked** (d√©verrouill√©e) - Vert

**Actions** :
- Cliquer sur une bo√Æte **locked** ‚Üí D√©marrer le quiz (`/quiz/:boxType`)
- Cliquer sur une bo√Æte **in-progress** (m√™me joueur) ‚Üí Reprendre (`/quiz/:boxType`)
- Cliquer sur une bo√Æte **in-progress** (autre joueur) ‚Üí Bloqu√© avec message
- Cliquer sur une bo√Æte **unlocked** ‚Üí Aucune action

**Logique de refresh** :
```typescript
// Actualiser l'√©tat toutes les 5 secondes
useEffect(() => {
  const interval = setInterval(() => {
    refreshSession();
  }, 5000);
  return () => clearInterval(interval);
}, []);
```

---

### 4. Quiz Page (`/quiz/:boxType`)
**Objectif** : R√©pondre aux 5 questions d'une bo√Æte

**Protection** :
```typescript
// V√©rifier qu'aucun autre joueur n'a commenc√©
const activeAttempt = await getActiveAttempt(sessionCode, boxType);
if (activeAttempt && activeAttempt.player_id !== currentPlayerId) {
  toast.error('Cette bo√Æte est d√©j√† en cours par un autre joueur !');
  navigate('/dashboard');
}
```

**Affichage** :
- Num√©ro de question (1/5, 2/5, etc.)
- Texte de la question
- 4 options de r√©ponse
- Bouton "Suivant" (d√©sactiv√© tant qu'aucune r√©ponse s√©lectionn√©e)

**Sauvegarde automatique** :
```typescript
// √Ä chaque r√©ponse
useEffect(() => {
  if (attemptId && answers.length > 0) {
    saveProgress(attemptId, currentQuestionIndex, answers);
  }
}, [answers, currentQuestionIndex]);
```

**Progression** :
1. Afficher question 1
2. Utilisateur choisit une r√©ponse
3. Clic sur "Suivant"
4. Sauvegarder r√©ponse en DB
5. Passer √† question 2
6. ... r√©p√©ter jusqu'√† question 5
7. Rediriger vers `/validation`

**Donn√©es sauvegard√©es** :
- `box_attempts` : Tentative active avec progression
- `player_answers` : Chaque r√©ponse individuelle

---

### 5. Validation Page (`/validation`)
**Objectif** : Afficher les r√©sultats du quiz

**Calcul du score** :
```typescript
const correctAnswers = answers.filter(a => a).length;
const score = (correctAnswers / totalQuestions) * 100;
const success = correctAnswers >= 3; // 60% minimum
```

**Affichage** :
- Score en pourcentage
- Nombre de bonnes r√©ponses (X/5)
- √âtat : ‚úÖ R√©ussi ou ‚ùå √âchou√©
- Si r√©ussi : Code de d√©verrouillage
- Boutons :
  - "D√©verrouiller" (si r√©ussi) ‚Üí `/unlock`
  - "R√©essayer" (si √©chou√©) ‚Üí `/quiz/:boxType`
  - "Retour au tableau de bord" ‚Üí `/dashboard`

**Marquer la fin de tentative** :
```typescript
await endAttempt(attemptId, score, success);
```

---

### 6. Unlock Page (`/unlock`)
**Objectif** : Valider le code de d√©verrouillage

**Affichage** :
- Champ de saisie pour le code
- Bouton "Valider"

**Validation** :
```typescript
const isValid = enteredCode === box.unlockCode;
if (isValid) {
  await unlockBox(sessionCode, boxType);
  toast.success("Bo√Æte d√©verrouill√©e !");
  navigate('/dashboard');
} else {
  toast.error("Code incorrect !");
}
```

**Sauvegarde** :
```typescript
// Ins√©rer dans box_unlocks
{
  session_id: sessionId,
  box_type: boxType,
  code_validated: true
}
```

---

### 7. Victory Page (`/victory`)
**Objectif** : C√©l√©brer la victoire

**Condition d'acc√®s** :
```typescript
// V√©rifier que les 4 bo√Ætes sont d√©verrouill√©es
const unlockedCount = session.codesValidated.length;
if (unlockedCount === 4) {
  navigate('/victory');
}
```

**Affichage** :
- Message de f√©licitations
- Temps total √©coul√©
- Liste des joueurs participants
- Bouton "Nouvelle mission" ‚Üí Retour √† `/`

---

## üì¶ √âtats des bo√Ætes

### Statut : **Locked** üîí
- Bo√Æte pas encore commenc√©e
- Couleur : Gris
- Action : Cliquer pour d√©marrer

### Statut : **In Progress** ‚è≥
- Un joueur a commenc√© mais pas termin√©
- Couleur : Orange
- Affichage : Nom du joueur en cours
- Actions :
  - M√™me joueur : Reprendre
  - Autre joueur : Bloqu√©

### Statut : **Unlocked** ‚úÖ
- Quiz r√©ussi et code valid√©
- Couleur : Vert
- Action : Aucune (bo√Æte termin√©e)

## üîÑ Syst√®me de sauvegarde et reprise

### Sauvegarde automatique
```typescript
// Sauvegarde toutes les 2 secondes
useEffect(() => {
  const autosave = setInterval(() => {
    if (attemptId && answers.length > 0) {
      saveProgress(attemptId, currentQuestionIndex, answers);
    }
  }, 2000);
  return () => clearInterval(autosave);
}, [attemptId, answers, currentQuestionIndex]);
```

### Reprise de progression
```typescript
// Au chargement de la page Quiz
useEffect(() => {
  const activeAttempt = await getActiveAttempt(sessionCode, boxType);
  if (activeAttempt && activeAttempt.player_id === currentPlayerId) {
    // Restaurer l'√©tat
    setAttemptId(activeAttempt.id);
    setCurrentQuestionIndex(activeAttempt.current_question_index);
    setAnswers(JSON.parse(activeAttempt.answers));
    setQuizStartTime(new Date(activeAttempt.quiz_start_time).getTime());
  }
}, []);
```

## ‚è≤Ô∏è Gestion du timer

### Timer global (60 minutes)
```typescript
// Calcul du temps restant
const timeElapsed = Date.now() - session.startTime;
const timeRemaining = GAME_DURATION - timeElapsed;

if (timeRemaining <= 0) {
  // Fin du jeu
  toast.error("Temps √©coul√© !");
  navigate('/dashboard');
}
```

### Format d'affichage
```typescript
const minutes = Math.floor(timeRemaining / 60000);
const seconds = Math.floor((timeRemaining % 60000) / 1000);
return `${minutes}:${seconds.toString().padStart(2, '0')}`;
```

## üé≤ Les 4 bo√Ætes th√©matiques

| Bo√Æte | Th√®me | Couleur | Code d√©verrouillage |
|-------|-------|---------|---------------------|
| **A** | üé® Arts et Culture | Violet | `ART2024` |
| **B** | üåç Environnement | Vert | `ECO2024` |
| **C** | ‚öïÔ∏è Sant√© | Rouge | `HEALTH2024` |
| **D** | ‚úàÔ∏è Tourisme | Bleu | `TRAVEL2024` |

Chaque bo√Æte contient **5 questions** avec **4 options** de r√©ponse.

## üèÜ Crit√®res de r√©ussite

### Pour une bo√Æte
- ‚úÖ R√©pondre correctement √† **au moins 3 questions sur 5** (60%)
- ‚úÖ Obtenir et valider le code de d√©verrouillage

### Pour la mission compl√®te
- ‚úÖ D√©verrouiller les **4 bo√Ætes** (A, B, C, D)
- ‚úÖ Avant la fin du **timer de 60 minutes**

## üîÑ Cycle complet d'une bo√Æte

```mermaid
stateDiagram-v2
    [*] --> Locked: Initial
    Locked --> InProgress: Joueur d√©marre quiz
    InProgress --> InProgress: Sauvegarde auto
    InProgress --> Validation: 5 questions r√©pondues
    Validation --> InProgress: √âchec (< 3/5), r√©essayer
    Validation --> Unlock: R√©ussite (‚â• 3/5)
    Unlock --> Unlocked: Code valid√©
    Unlocked --> [*]: Bo√Æte termin√©e
```

## üíæ Stockage local

### LocalStorage
```typescript
// Donn√©es sauvegard√©es
localStorage.setItem('current_session_code', sessionCode);
localStorage.setItem('current_player_id', playerId);
localStorage.setItem('current_player_pseudo', pseudo);
```

### Session
Donn√©es synchronis√©es avec Supabase :
- √âtat des bo√Ætes
- Progression des quiz
- R√©ponses des joueurs
- D√©verrouillages

## üö´ R√®gles de validation

### Session
- ‚ùå Impossible de rejoindre une session termin√©e
- ‚ùå Le code session doit √™tre valide
- ‚úÖ Plusieurs joueurs peuvent rejoindre

### Bo√Ætes
- ‚ùå Un seul joueur par bo√Æte √† la fois
- ‚ùå Impossible de d√©verrouiller sans le bon code
- ‚úÖ Possible de r√©essayer un quiz √©chou√©

### Quiz
- ‚ùå Impossible de passer √† la question suivante sans r√©pondre
- ‚ùå Impossible de revenir en arri√®re
- ‚úÖ Sauvegarde automatique de la progression
